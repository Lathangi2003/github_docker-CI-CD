
name: Build WAR and Push Docker Image to ECR (Public)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

# ---------- Define variables once (replace dummy values) ----------
env:
  AWS_REGION: us-east-1                 # ECR Public auth region (must be us-east-1)
  ECR_REGISTRY: public.ecr.aws          # ECR Public registry host
  ECR_REPOSITORY: e8k8i3u3/ltimindtree  # <namespace>/<repo> in ECR Public
  IMAGE_TAG: latest                     # or use ${{ github.sha }} for immutable tags
# -----------------------------------------------------------------

jobs:
  build-and-push:
    runs-on: [ self-hosted, dev ]
    environment: ECR Secrets

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Make build.sh executable
        run: chmod +x build.sh

      - name: Build WAR
        run: ./build.sh
        # Ensure ROOT.war is at repo root or update Dockerfile COPY path

      - name: Debug variables (optional)
        run: |
          echo "REGISTRY=[${ECR_REGISTRY}]"
          echo "REPOSITORY=[${ECR_REPOSITORY}]"
          echo "REGION=[${AWS_REGION}]"
          echo "IMAGE_TAG=[${IMAGE_TAG}]"

      - name: Login to Amazon ECR Public
        run: |
          # ECR Public login always targets public.ecr.aws and us-east-1
          aws ecr-public get-login-password --region "$AWS_REGION" | \
          docker login --username AWS --password-stdin "$ECR_REGISTRY"

      - name: Build Docker image (Tomcat + WAR) with full ECR Public name
        run: |
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          docker build -t "$IMAGE_URI" .

      - name: Push image to ECR Public
        run: |
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          docker push "$IMAGE_URI"

      
      - name: Remove old container and run new one
        run: |
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          echo "pulling..."
          docker pull $IMAGE_URI
          docker stop tomcat-app || true
          docker rm tomcat-app || true
          docker run -d --name tomcat-app -p 80:8080 $IMAGE_URI
